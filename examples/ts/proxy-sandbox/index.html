<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Flowersec Proxy Sandbox Demo (Browser)</title>
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 24px; max-width: 1100px; }
      textarea { width: 100%; height: 200px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; }
      pre { background: #0b1020; color: #e8e8e8; padding: 12px; border-radius: 8px; overflow: auto; }
      button { padding: 8px 12px; }
      iframe { width: 100%; height: 680px; border: 1px solid #ddd; border-radius: 8px; }
      .row { display: flex; gap: 12px; align-items: center; margin: 12px 0; }
      .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; }
    </style>
  </head>
  <body>
    <h1>Flowersec Proxy Sandbox Demo (Browser)</h1>
    <p>
      This demo shows <span class="mono">flowersec-proxy/http1</span> + <span class="mono">flowersec-proxy/ws</span> in runtime mode:
      a Service Worker intercepts requests for <span class="mono">/examples/ts/proxy-sandbox/app/</span> and forwards them to a Flowersec runtime.
    </p>
    <p>
      Paste JSON from <span class="mono">/v1/channel/init</span> (either the full object or <span class="mono">grant_client</span> only).
    </p>

    <textarea id="in" spellcheck="false"></textarea>

    <div class="row">
      <button id="fetch" disabled>Fetch Grant</button>
      <button id="connect">Connect</button>
      <button id="open" disabled>Open App</button>
      <button id="close" disabled>Close</button>
      <span id="status" class="mono"></span>
    </div>

    <pre id="out"></pre>

    <iframe id="app" title="proxied app"></iframe>

    <script type="module">
      import { connectTunnelBrowser } from "../../../flowersec-ts/dist/browser/index.js";
      import { createProxyRuntime } from "../../../flowersec-ts/dist/proxy/index.js";

      const $in = document.getElementById("in");
      const $out = document.getElementById("out");
      const $fetch = document.getElementById("fetch");
      const $connect = document.getElementById("connect");
      const $open = document.getElementById("open");
      const $close = document.getElementById("close");
      const $status = document.getElementById("status");
      const $app = document.getElementById("app");

      let client = null;
      let runtime = null;

      function logLine(s) {
        $out.textContent += s + "\n";
      }
      function setStatus(s) {
        $status.textContent = s;
      }

      async function detectDevServer() {
        try {
          const resp = await fetch("/__demo/status");
          if (!resp.ok) return;
          $fetch.disabled = false;
          setStatus("dev server detected");
        } catch {
          // ignore
        }
      }

      $fetch.addEventListener("click", async () => {
        $out.textContent = "";
        setStatus("fetching grant...");
        try {
          const resp = await fetch("/__demo/channel/init", {
            method: "POST",
            headers: { "content-type": "application/json" },
            body: "{}",
          });
          const text = await resp.text();
          if (!resp.ok) throw new Error(`fetch failed (${resp.status}): ${text}`);
          const obj = JSON.parse(text);
          $in.value = JSON.stringify(obj, null, 2);
          setStatus("grant loaded");
        } catch (e) {
          setStatus("fetch failed");
          logLine(String(e?.stack ?? e));
        }
      });

      async function ensureServiceWorker() {
        // The SW is scoped to /examples/ts/proxy-sandbox/ but only proxies /examples/ts/proxy-sandbox/app/.
        const reg = await navigator.serviceWorker.register("./sw.js", { scope: "./" });
        await navigator.serviceWorker.ready;
        return reg;
      }

      $connect.addEventListener("click", async () => {
        $out.textContent = "";
        setStatus("connecting...");
        try {
          const obj = JSON.parse($in.value);
          client = await connectTunnelBrowser(obj);
          runtime = createProxyRuntime({ client });
          // Make runtime discoverable to the injected app bootstrap (SW-injected <script>).
          window.__flowersecProxyRuntime = runtime;
          await ensureServiceWorker();
          $open.disabled = false;
          $close.disabled = false;
          setStatus("connected (sw ready)");
        } catch (e) {
          setStatus("connect failed");
          logLine(String(e?.stack ?? e));
        }
      });

      $open.addEventListener("click", async () => {
        if (!runtime) return;
        $app.src = "./app/";
      });

      $close.addEventListener("click", async () => {
        try {
          $app.src = "about:blank";
          runtime?.dispose();
          client?.close();
        } catch {
          // ignore
        } finally {
          client = null;
          runtime = null;
          $open.disabled = true;
          $close.disabled = true;
          setStatus("closed");
        }
      });

      detectDevServer();
    </script>

    <script>
      // Used by the injected bootstrap script (same-origin iframe).
      window.__flowersecProxyRuntime = null;
    </script>
  </body>
</html>

