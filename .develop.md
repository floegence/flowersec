# Flowersec 开发规范

> 目标：让开发与 CI 对齐、避免在 `main` 上直接开发、避免把临时文档/草稿提交进仓库。

---

## 0. Git 开发模式（Worktree，强制）

- 本仓库永远不在 `main` 分支上直接开发：`main` 只做同步（`pull --ff-only`）与合并（merge）。
- 冲突处理：**冲突必须在 feature worktree 内解决**；如果在 `main` 上执行 merge 出现冲突，立刻 `git merge --abort`，回 feature 分支同步 `main` 后重试。
- 同步 `main` 的策略（强制）：每个 worktree 只允许在“准备合并”阶段执行一次 `git rebase origin/main`（最后一次 rebase）；后续若还需要跟进 `main` 的更新，只能在 feature 分支上用 `git merge origin/main`。
- feature 开发：一个 feature = 一个 worktree 目录 + 一个分支；目录放在父目录，命名统一使用 `../flowersec-feat-<topic>`，分支命名统一使用 `feat-<topic>`。

模板：

```bash
git fetch origin
git switch main
git pull --ff-only

BR=feat-<topic>
WT=../flowersec-feat-<topic>
git worktree add -b "$BR" "$WT" origin/main
```

在新 worktree 目录里开发并跑完门禁（以 `make check`/CI 为准）。准备合并前（**仅允许一次 rebase**），先把 `main` 的最新变更同步到 feature 分支并前置解决冲突：

```bash
# 在 "$WT"（feature worktree）执行
git fetch origin
git rebase origin/main

# 如有冲突：解决后执行
# git add <files>
# git rebase --continue
#
# rebase 完成后重新跑门禁（make check），确保全绿
```

如果完成“最后一次 rebase”后，`main` 又有新提交需要继续同步：**只能 merge，禁止再次 rebase**：

```bash
# 在 "$WT"（feature worktree）执行
git fetch origin
git merge origin/main

# 如有冲突：解决后提交这个 merge commit
# 然后再次跑门禁（make check）
```

确认 feature 分支已包含当前 `origin/main` 且门禁全绿后，回到 `main` 工作区合并并清理 worktree/分支：

```bash
git switch main
git pull --ff-only
git merge --no-ff "$BR"
git push origin main

git worktree remove "$WT"
git branch -d "$BR"
```

---

## 1. 开发过程临时文档（不入库，完成后删除）

- 开发过程中允许编写临时文档（需求拆解、问题分析、落地方案、checklist 等），用于推进协作与保证质量。
- 这些临时文档 **不得提交到代码库**：
  - 推荐放在仓库外（最省心，不会污染目录结构）。
  - 若必须放在仓库内：必须落在 `.gitignore` 覆盖的路径下，且在合并前确保 `git status` 不会出现它们。
- 当 feature 开发完成并合并后，必须随手删除这些临时文档，避免长期堆积“历史草稿”导致误导与泄露风险。

---

## 2. 提交前本地质量门禁（必须执行）

- 单一事实来源：以 CI 为准；本地至少跑通 `make check`（仓库根目录 `Makefile` 已收敛）。
- `make check` 会覆盖：
  - Go：fmt/lint/test/race/vulncheck
  - TS：npm ci/lint/test/build/audit
  - IDL codegen：gen-check（防止忘记提交生成产物）

---

## 3. Release / Tag 规则

- Go SDK（`flowersec-go`）发布使用 tag：`flowersec-go/v<version>`（例如 `flowersec-go/v0.9.0`）。
- 当下游仓库需要新能力时，优先 upstream-first：先在本仓库完成实现与门禁 → 合并到 `main` → 打 tag 并 push → 确认发布成功 → 再到下游升级依赖。
